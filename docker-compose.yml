services:
  gluetun:
      image: qmcgaw/gluetun:latest
      container_name: gluetun
      cap_add:
        - NET_ADMIN
      devices:
        - /dev/net/tun:/dev/net/tun
      ports:
        - 8081:8080/tcp
      environment:
        - TZ=${TZ}
        - UPDATER_PERIOD=24h
        - VPN_SERVICE_PROVIDER=protonvpn
        - VPN_TYPE=wireguard # Assure-toi que c'est bien "wireguard"
        - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
        
        # --- SOLUTIONS AUX TIMEOUTS ---
        - WIREGUARD_IMPLEMENTATION=userspace  # Force le mode utilisateur (plus stable en Docker)
        - DOT=off                             # Désactive DNS over TLS (les logs montraient une erreur 853)
        - DNS_ADDRESS=1.1.1.1                 # Utilise un DNS classique pour le healthcheck
        - VPN_INTERFACE_MTU=1320              # Réduit le MTU pour éviter la fragmentation des paquets
        
        # --- PORT FORWARDING ---
        - VPN_PORT_FORWARDING=on
        - VPN_PORT_FORWARDING_UP_COMMAND=/bin/sh -c 'wget -O- --retry-connrefused --post-data "json={\"listen_port\":{{PORTS}}}" http://127.0.0.1:8080/api/v2/app/setPreferences 2>&1'
        
        # --- AUTRES ---
        - BLOCK_MALICIOUS=off
        - SERVER_COUNTRIES=${SERVER_COUNTRIES}
        - HTTPPROXY=on
      # --- DESACTIVATION IPV6 (Crucial pour le routage VPN) ---
      sysctls:
        - net.ipv6.conf.all.disable_ipv6=1
      volumes:
        - ./gluetun/config:/gluetun
      networks:
        - ${TRAEFIK_NETWORK}
      restart: unless-stopped
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.qbittorrent.rule=Host(`${QBITTORRENT_PREFIX}.${DOMAIN}`)"
        - "traefik.http.routers.qbittorrent.entrypoints=websecure"
        - "traefik.http.routers.qbittorrent.tls.certresolver=myresolver"
        - "traefik.http.services.qbittorrent.loadbalancer.server.port=8080"

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./radarr/config:/config
      - ./data:/data
    networks:
      - ${TRAEFIK_NETWORK}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`${RADARR_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls.certresolver=myresolver"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./sonarr/config:/config
      - ./data:/data
    networks:
      - ${TRAEFIK_NETWORK}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`${SONARR_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls.certresolver=myresolver"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
    volumes:
      - ./qbittorrent/config:/config
      - ./data:/data
    restart: unless-stopped
    network_mode: "service:gluetun"

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./prowlarr/config:/config
    networks:
      - ${TRAEFIK_NETWORK}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`${PROWLARR_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.tls.certresolver=myresolver"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ}
    networks:
      - ${TRAEFIK_NETWORK}
    restart: unless-stopped

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}
    volumes:
      - ./plex/config:/config
      - ./data/movies:/movies
      - ./data/tv:/tv
      - ${PLEX_SHARED}:/pictures # Optional, for photo libraries linked to Nextcloud
    ports:
      - "32400:32400"
    networks:
      - ${TRAEFIK_NETWORK}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plex.rule=Host(`${PLEX_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.plex.entrypoints=websecure"
      - "traefik.http.routers.plex.tls.certresolver=myresolver"
      - "traefik.http.services.plex.loadbalancer.server.port=32400"

  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./overseerr/config:/config
    networks:
      - ${TRAEFIK_NETWORK}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.overseerr.rule=Host(`${OVERSEERR_PREFIX}.${DOMAIN}`)"
      - "traefik.http.routers.overseerr.entrypoints=websecure"
      - "traefik.http.routers.overseerr.tls.certresolver=myresolver"
      - "traefik.http.services.overseerr.loadbalancer.server.port=5055"

networks:
  traefik-net:
    external: true
